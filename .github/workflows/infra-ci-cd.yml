name: Infra Deploy

on:
  push:
    branches:
      - main
    # 인프라 관련 파일이 수정될 때만 작동하도록 최적화
    paths:
      - 'nginx.conf'
      - 'monitoring/prometheus.yml'
      - 'monitoring/grafana/provisioning/**'
      - 'docker-compose.prod.yml'
  workflow_dispatch: # 수동 실행 버튼 활성화

jobs:
  deploy-infra:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # [검증 단계] 파일이 실제 존재하는지 로그로 확인 (디버깅용)
      - name: Verify infra files
        run: |
          ls -l nginx.conf
          ls -l docker-compose.prod.yml
          find monitoring -type f

      # [파일 전송] 서버의 /app 폴더로 전송
      - name: Sync infra files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          # 콤마 뒤에 공백 없이 작성하는 것이 가장 안전함
          source: "nginx.conf,monitoring/prometheus.yml,monitoring/grafana/provisioning/**,docker-compose.prod.yml"
          target: "/app"
          strip_components: 0 # 폴더 구조 유지
          overwrite: true

      # [명령 실행] 서버에서 컨테이너 재시작
      - name: Recreate containers
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            cd /app
            # 설정값 변경 사항을 반영하여 컨테이너 재생성
            # --no-deps는 의존성 무시, --force-recreate는 강제 재생성
            docker compose -f docker-compose.prod.yml up -d nginx prometheus grafana --no-deps --force-recreate
            
            # 사용하지 않는 리소스 정리 (선택사항)
            docker image prune -f